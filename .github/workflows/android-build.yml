name: Android Build and Test

# CI/CD Pipeline for ESP32 BPM Detector Android App
# Adapted from sparetools android-consumer.yml

on:
  push:
    branches: [ main, develop, 'release/*' ]
    paths:
      - 'android-app/**'
      - '.github/workflows/android-build.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'android-app/**'
      - '.github/workflows/android-build.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write
  security-events: write

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true"

jobs:
  # Android app build
  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "Debug Build"
            build-type: "assembleDebug"
          - name: "Release Build"
            build-type: "assembleRelease"
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          target: default
          arch: x86_64
          packages: 'platform-tools,build-tools;34.0.0,platforms;android-34'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android-app/**/*.gradle*', 'android-app/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make gradlew executable
        working-directory: android-app
        run: chmod +x gradlew

      - name: Build Android APK
        working-directory: android-app
        run: ./gradlew ${{ matrix.build-type }} --no-daemon --parallel

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bpm-detector-${{ matrix.build-type }}-${{ github.sha }}
          path: |
            android-app/app/build/outputs/apk/**/*.apk
          retention-days: 30

      - name: Display build summary
        if: always()
        run: |
          echo "## ðŸ“± Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ matrix.name }} | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY

  # Android tests
  test-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          target: default
          arch: x86_64
          packages: 'platform-tools,build-tools;34.0.0,platforms;android-34'

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android-app/**/*.gradle*', 'android-app/gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make gradlew executable
        working-directory: android-app
        run: chmod +x gradlew

      - name: Run unit tests
        working-directory: android-app
        run: ./gradlew test --no-daemon

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: android-app/app/build/test-results/**/*.xml
          retention-days: 7

  # Security scan
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'android-app'
          format: 'sarif'
          output: 'trivy-android-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-android-results.sarif'
          category: "android-security"

      - name: Check for critical vulnerabilities
        run: |
          if [ -f "trivy-android-results.sarif" ]; then
            CRITICAL_COUNT=$(grep -o '"level":"error"' trivy-android-results.sarif | wc -l || echo "0")
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "ðŸš¨ Found $CRITICAL_COUNT critical security issues"
              exit 1
            else
              echo "âœ… No critical security issues found"
            fi
          fi

  # Publish APKs to GitHub Packages
  publish-packages:
    needs: [build-android, test-android, security-scan]
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Download APK artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bpm-detector-*-*
          merge-multiple: true
          path: ./apks

      - name: Get version from build.gradle
        id: get_version
        working-directory: android-app
        run: |
          VERSION_NAME=$(grep -oP 'versionName\s+["\047]\K[^"\047]+' app/build.gradle | head -1)
          VERSION_CODE=$(grep -oP 'versionCode\s+\K\d+' app/build.gradle | head -1)
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION_NAME ($VERSION_CODE)"

      - name: Create package metadata
        run: |
          mkdir -p ./package
          cat > ./package/package.json << EOF
          {
            "name": "esp32-bpm-detector-android",
            "version": "${{ steps.get_version.outputs.version_name }}",
            "description": "ESP32 BPM Detector Android Application",
            "repository": "${{ github.repository }}",
            "package_type": "android-apk",
            "build_number": "${{ steps.get_version.outputs.version_code }}",
            "commit_sha": "${{ github.sha }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: Publish to GitHub Packages
        uses: actions/upload-artifact@v4
        with:
          name: bpm-detector-package-${{ steps.get_version.outputs.version_name }}
          path: |
            ./apks
            ./package
          retention-days: 90

      - name: Publish to GitHub Packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_VERSION="${{ steps.get_version.outputs.version_name }}"
          PACKAGE_NAME="esp32-bpm-detector-android"
          
          echo "Publishing APKs to GitHub Packages..."
          
          # Find all APK files and create package entries
          for apk in ./apks/**/*.apk; do
            if [ -f "$apk" ]; then
              APK_NAME=$(basename "$apk")
              BUILD_TYPE=$(echo "$APK_NAME" | grep -oE "(debug|release)" || echo "unknown")
              
              echo "ðŸ“¦ Preparing $APK_NAME for GitHub Packages..."
              
              # Get file size and SHA256
              FILE_SIZE=$(stat -f%z "$apk" 2>/dev/null || stat -c%s "$apk" 2>/dev/null || echo "0")
              FILE_SHA256=$(shasum -a 256 "$apk" | cut -d' ' -f1 || sha256sum "$apk" | cut -d' ' -f1 || echo "")
              
              echo "  File: $APK_NAME"
              echo "  Size: $FILE_SIZE bytes"
              echo "  SHA256: $FILE_SHA256"
              echo "  Build Type: $BUILD_TYPE"
              echo "  âœ“ Prepared for publishing"
            fi
          done
          
          echo ""
          echo "âœ… APKs are available via:"
          echo "   - GitHub Actions artifacts (90 days retention)"
          echo "   - GitHub Releases (when tags are created)"
          echo "   - Download from workflow run artifacts"

      - name: Get release notes
        id: release_notes
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          RELEASE_NOTES=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")..HEAD 2>/dev/null || echo "- See commit history for changes")
          
          cat > release_body.md << EOF
          ## ESP32 BPM Detector Android App - ${{ steps.get_version.outputs.version_name }}
          
          **Version:** ${{ steps.get_version.outputs.version_name }}  
          **Build Number:** ${{ steps.get_version.outputs.version_code }}  
          **Commit:** ${{ github.sha }}
          
          ### ðŸ“¦ APK Files
          
          This release includes both debug and release APK builds:
          
          - **Debug APK**: For testing and development
          - **Release APK**: Production-ready build (recommended)
          
          ### ðŸ“¥ Installation
          
          1. Download the APK file for your needs
          2. On your Android device, enable "Install from unknown sources" in Settings
          3. Transfer the APK to your device and tap to install
          4. Grant necessary permissions when prompted
          
          ### ðŸ”§ Requirements
          
          - Android 7.0 (API 24) or higher
          - WiFi connection to access ESP32 device
          
          ### ðŸ“ Changes
          
          $RELEASE_NOTES
          
          ### ðŸ”— Links
          
          - [Repository](https://github.com/${{ github.repository }})
          - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Issues](https://github.com/${{ github.repository }}/issues)
          EOF
          
          echo "body_path=release_body.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ./apks/**/*.apk
          body_path: release_body.md
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create package registry entry
        if: github.event_name != 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_VERSION="${{ steps.get_version.outputs.version_name }}-${{ github.run_number }}"
          PACKAGE_NAME="esp32-bpm-detector-android"
          
          echo "Creating package registry entry..."
          
          # Create package metadata
          cat > package-info.json << EOF
          {
            "name": "$PACKAGE_NAME",
            "version": "$PACKAGE_VERSION",
            "description": "ESP32 BPM Detector Android Application",
            "repository": "${{ github.repository }}",
            "package_type": "android-apk",
            "build_number": "${{ steps.get_version.outputs.version_code }}",
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF
          
          echo "Package info:"
          cat package-info.json
          echo ""
          echo "âœ… Package metadata created"

      - name: Display publish summary
        if: always()
        run: |
          echo "## ðŸ“¦ Package Publishing Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.get_version.outputs.version_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Number | ${{ steps.get_version.outputs.version_code }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download APKs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APKs are available via:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Workflow Artifacts**: Click 'Summary' above â†’ Download artifacts (90 days retention)" >> $GITHUB_STEP_SUMMARY
          echo "2. **GitHub Releases**: Available when tags are created" >> $GITHUB_STEP_SUMMARY
          echo "3. **Package Registry**: Metadata stored in package-info.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View all workflow runs](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "- [View releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY


