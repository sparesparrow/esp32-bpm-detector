# ESP32 BPM Detector - Test Environment
# Specialized container for running comprehensive tests
# Based on the build environment with additional testing tools

FROM ubuntu:20.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PLATFORMIO_CORE_DIR=/opt/platformio
ENV PYTHONUNBUFFERED=1

# Install system dependencies for testing
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-dev \
    git \
    curl \
    wget \
    build-essential \
    cmake \
    ninja-build \
    libffi-dev \
    libssl-dev \
    netcat \
    telnet \
    tcpdump \
    lsof \
    htop \
    vim \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install PlatformIO
RUN pip3 install --upgrade pip
RUN pip3 install platformio

# Install ESP32 toolchain dependencies
RUN apt-get update && apt-get install -y \
    gcc-multilib \
    g++-multilib \
    && rm -rf /var/lib/apt/lists/*

# Install test dependencies
RUN pip3 install \
    pytest>=7.0.0 \
    pytest-asyncio>=0.21.0 \
    pytest-cov \
    pytest-xdist \
    requests \
    socketio-client \
    websockets \
    netifaces \
    psutil \
    docker \
    pyyaml \
    && rm -rf /root/.cache/pip

# Create workspace directory
WORKDIR /workspace

# Create test results directory
RUN mkdir -p /workspace/test_results /workspace/logs

# Copy project files
COPY . /workspace/

# Install project dependencies (will be done at runtime)
# RUN pio pkg install

# Set up Python path for MCP-Prompts integration
ENV PYTHONPATH="/workspace:$PYTHONPATH"

# Set environment variables for testing
ENV HARDWARE_EMULATOR_HOST=127.0.0.1
ENV HARDWARE_EMULATOR_PORT=12345
ENV DOCKER_TEST_ENABLED=true
ENV TEST_RESULTS_DIR=/workspace/test_results

# Expose ports for emulator and testing
EXPOSE 12345 8000 8080

# Default command - keep container running for testing
CMD ["tail", "-f", "/dev/null"]