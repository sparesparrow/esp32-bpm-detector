[platformio]
default_envs = esp32s3

[env:esp32s3]
platform = espressif32@6.4.0
board = esp32-s3-devkitc-1
framework = arduino
monitor_speed = 115200
upload_speed = 460800
upload_protocol = esptool
; upload_port can be specified via CLI: --upload-port /dev/ttyACM0
; Multi-device deployment automatically sets this via deploy_all_devices.py

# Build flags for ESP32
build_flags =
    -D CORE_DEBUG_LEVEL=2
    -D DEBUG_ESP_PORT=Serial
    -D PLATFORM_ESP32
    -std=c++17
    -O2
    -I.
    -Isrc
    -Iinclude
    -D CONFIG_IDF_TARGET_ESP32S3=1
    -Wno-cpp  # Suppress #warning directives from libraries
    -DFLATBUFFERS_VERSION_MAJOR=24
    -DFLATBUFFERS_VERSION_MINOR=3
    -DFLATBUFFERS_VERSION_REVISION=25

# Exclude Arduino platform files from ESP32 build
build_src_filter = +<*> -<platforms/arduino/>

# Libraries (ESP32-specific)
lib_deps =
    # FFT for beat detection (works on both platforms)
    kosme/arduinoFFT @ ^1.4.0

    # ESP32-only libraries
    ottowinter/ESPAsyncWebServer-esphome @ ^3.1.0
    me-no-dev/AsyncTCP @ ^1.1.1
    adafruit/Adafruit SSD1306 @ ^2.5.7
    # TM1637Display @ ^1.1.0 (removed as it's not used and causing build warnings)
    bblanchon/ArduinoJson @ ^6.21.2
    knolleary/PubSubClient @ ^2.8.0

    # FlatBuffers is included locally in lib/flatbuffers

# Optimization flags
[env:esp32dev-release]
platform = espressif32@6.4.0
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600
; upload_port can be specified via CLI: --upload-port /dev/ttyUSB0
; Multi-device deployment automatically sets this via deploy_all_devices.py
build_flags =
    -D CORE_DEBUG_LEVEL=0
    -D PLATFORM_ESP32
    -O3
    -std=c++17
    -I.
    -Isrc
    -Iinclude

# Exclude Arduino platform files from ESP32 build
build_src_filter = +<*> -<platforms/arduino/>

# Libraries (same as esp32s3)
lib_deps =
    kosme/arduinoFFT @ ^1.4.0
    ottowinter/ESPAsyncWebServer-esphome @ ^3.1.0
    me-no-dev/AsyncTCP @ ^1.1.1
    bblanchon/ArduinoJson @ ^6.21.2

# Test environment (for development/debugging)
[env:esp32dev-debug]
platform = espressif32@6.4.0
board = esp32dev
framework = arduino
monitor_speed = 115200
upload_speed = 921600
build_flags =
    -D CORE_DEBUG_LEVEL=5
    -D PLATFORM_ESP32
    -g
    -O0
    -std=c++17

# Arduino Uno BPM Display Client
# Receives BPM data from ESP32 via serial and displays on I2C OLED
# 
# Wiring:
#   OLED Display: SCL→A5, SDA→A4, VCC→3.3V, GND→GND
#   ESP32 Serial: ESP32-TX→Arduino-RX(Pin0), ESP32-RX→Arduino-TX(Pin1), GND→GND
#
[env:arduino_uno_display]
platform = atmelavr
board = uno
framework = arduino
monitor_speed = 9600
upload_speed = 115200
; upload_port can be specified via CLI: --upload-port /dev/ttyUSB1 or /dev/ttyACM0
; Multi-device deployment automatically sets this via deploy_all_devices.py

# Build flags for Arduino
build_flags =
    -D PLATFORM_ARDUINO
    -D ARDUINO_BPM_DISPLAY_CLIENT
    -std=c++11
    -Os  # Optimize for size (critical for 32KB flash)
    -fno-exceptions  # Disable exceptions to save space
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections

# Source filter - only build the display client main file
# Note: Filter includes all first, then excludes all, then re-includes specific file
src_filter = -<*> +<arduino_display_main.cpp>

# Libraries for OLED display and serial communication
# Note: SoftwareSerial is built into Arduino AVR core, no need to add
lib_deps =
    adafruit/Adafruit SSD1306 @ ^2.5.7
    adafruit/Adafruit GFX Library @ ^1.11.3
    adafruit/Adafruit BusIO @ ^1.14.1

# Arduino Uno environment (original - for BPM detection, limited by memory)
[env:arduino_uno]
platform = atmelavr
board = uno
framework = arduino
monitor_speed = 9600
upload_speed = 9600
; upload_port can be specified via CLI: --upload-port /dev/ttyUSB1
; Multi-device deployment automatically sets this via deploy_all_devices.py

# Build flags for Arduino
build_flags =
    -D PLATFORM_ARDUINO
    -std=c++11  # Arduino uses C++11
    -O2
    -I.
    -Isrc

# Exclude platforms subdirectory and use minimal code
build_src_filter = +<*> -<platforms/> -<clients/>

# Arduino Nano environment
[env:arduino_nano]
platform = atmelavr
board = nanoatmega328
framework = arduino
monitor_speed = 9600
upload_speed = 9600

# Build flags for Arduino Nano
build_flags =
    -D PLATFORM_ARDUINO
    -std=c++11
    -O2
    -I.
    -Isrc
