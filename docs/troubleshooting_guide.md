# ESP32 BPM Detector - Troubleshooting Guide

*Generated by MCP-Prompts `/debugging-assistant`*

## Overview

This comprehensive troubleshooting guide helps diagnose and resolve issues with the ESP32 BPM detector system. Use this guide when encountering problems during development, testing, or deployment.

## Quick Diagnostic Checklist

### System Health Check
```bash
# 1. Check ESP32 connection
pio device list

# 2. Monitor serial output
pio device monitor -e esp32-s3-debug

# 3. Check firmware version
curl http://esp32-bpm.local/api/v1/system/health

# 4. Verify BPM detection
curl http://esp32-bpm.local/api/v1/bpm/current
```

### Performance Metrics
- **CPU Usage**: Should be < 50% during normal operation
- **Memory Usage**: Should be < 80% of ESP32-S3 RAM
- **BPM Accuracy**: Should be ¬±3 BPM for stable signals
- **Network Latency**: Should be < 100ms for API responses

## Common Issues and Solutions

### üî¥ CRITICAL: System Won't Boot

**Symptoms:**
- ESP32 doesn't respond to serial commands
- No LED activity or display output
- Firmware upload fails

**Diagnostic Steps:**
1. Check power supply (3.3V, 1A minimum)
2. Verify ESP32-S3 pin connections
3. Test with minimal firmware (blink LED)
4. Check for hardware shorts/damage

**Solutions:**
```cpp
// Minimal test firmware
void setup() {
    pinMode(2, OUTPUT);  // Built-in LED
}

void loop() {
    digitalWrite(2, HIGH);
    delay(1000);
    digitalWrite(2, LOW);
    delay(1000);
}
```

### üü° HIGH: WiFi Connection Issues

**Symptoms:**
- ESP32 not visible on network
- API endpoints return connection errors
- mDNS discovery fails (.local address not working)

**Diagnostic Steps:**
```bash
# Check WiFi configuration
grep "WIFI_SSID\|WIFI_PASSWORD" src/config.h

# Test WiFi connection manually
curl -X POST http://192.168.1.100/api/v1/system/config \
  -H "Content-Type: application/json" \
  -d '{"wifi_ssid":"YourNetwork","wifi_password":"YourPassword"}'

# Verify network connectivity
ping esp32-bpm.local
```

**Common Causes:**
1. **Incorrect WiFi Credentials**
   - Check SSID/password in config.h
   - Verify 2.4GHz network (ESP32 doesn't support 5GHz)
   - Test credentials with another device

2. **IP Address Conflicts**
   - Check router DHCP settings
   - Verify static IP configuration
   - Look for IP address conflicts on network

3. **Signal Strength Issues**
   - Move ESP32 closer to router
   - Check antenna orientation
   - Verify no metal enclosures blocking signal

**Solutions:**
```cpp
// Enhanced WiFi debugging in config.h
#define DEBUG_WIFI 1
#define WIFI_CONNECT_TIMEOUT_MS 30000
#define WIFI_RETRY_ATTEMPTS 5
```

### üü° HIGH: BPM Detection Inaccurate

**Symptoms:**
- BPM readings vary wildly (¬±20+ BPM)
- Low confidence scores (< 0.3)
- No BPM detected on known audio sources

**Diagnostic Steps:**
```bash
# Enable detailed debugging
#define DEBUG_SERIAL 1
#define DEBUG_FFT 1
#define DEBUG_BEATS 1

# Test with known frequency
# Play 120 BPM sine wave and check detection
curl http://esp32-bpm.local/api/v1/bpm/current

# Check ADC signal levels
# Should see values between 1800-2200 for good signal
```

**Common Causes:**
1. **Poor Audio Input Quality**
   - Microphone gain too low/high
   - Incorrect ADC pin configuration
   - Background noise interference

2. **FFT Configuration Issues**
   - Wrong sample rate for audio source
   - Incorrect window size for BPM range
   - Poor window function selection

3. **Algorithm Parameters**
   - Detection threshold too high/low
   - Incorrect BPM range limits
   - Peak detection sensitivity issues

**Calibration Procedure:**
```bash
# Run automated calibration
python3 scripts/calibrate_audio.py

# Manual calibration steps:
# 1. Play 120 BPM reference track
# 2. Adjust GAIN_LEVEL in config.h
# 3. Modify THRESHOLD_DB if needed
# 4. Rebuild and test
```

### üü† MEDIUM: Memory Issues

**Symptoms:**
- System crashes with "Heap exhausted" errors
- Performance degrades over time
- Display becomes unresponsive

**Diagnostic Steps:**
```cpp
// Enable memory debugging
#define DEBUG_MEMORY 1

// Check heap usage
DEBUG_PRINT("Free heap: ");
DEBUG_PRINTLN(ESP.getFreeHeap());
DEBUG_PRINT("Heap fragmentation: ");
DEBUG_PRINTLN(ESP.getHeapFragmentation());
```

**Common Causes:**
1. **Memory Leaks**
   - FlatBuffers not properly cleaned up
   - Network buffers accumulating
   - Task stack overflows

2. **Buffer Size Issues**
   - FFT buffers too large for ESP32 RAM
   - Audio ring buffer oversized
   - Display buffers consuming too much memory

**Solutions:**
```cpp
// Memory optimization settings
#define USE_PSRAM_FOR_BUFFERS 1  // Move large buffers to PSRAM
#define REDUCE_FFT_SIZE 1        // Use 512-point FFT if needed
#define ENABLE_MEMORY_MONITORING 1  // Track memory usage
```

### üü† MEDIUM: Display Problems

**Symptoms:**
- No display output or garbled text
- Display updates too slowly
- OLED shows wrong information

**Diagnostic Steps:**
```cpp
// Check display configuration
#define USE_OLED_DISPLAY 1
#define OLED_I2C_ADDRESS 0x3C  // Verify correct address
#define OLED_SDA_PIN 21       // Check pin assignments
#define OLED_SCL_PIN 22
```

**Common Issues:**
1. **I2C Communication Failures**
   - Wrong I2C pins or address
   - Insufficient pull-up resistors
   - I2C bus conflicts

2. **Library Compatibility**
   - Wrong OLED library version
   - Incorrect display initialization
   - Font size issues

**Solutions:**
```cpp
// Display debugging
#define DEBUG_DISPLAY 1

// Test display independently
void testDisplay() {
    display.clear();
    display.setCursor(0, 0);
    display.println("Display Test");
    display.display();
}
```

### üü¢ LOW: Performance Issues

**Symptoms:**
- BPM detection lag (> 100ms)
- System feels sluggish
- High CPU usage warnings

**Diagnostic Steps:**
```cpp
// Enable performance monitoring
#define DEBUG_PERFORMANCE 1

// Monitor timing
unsigned long startTime = micros();
// ... code to measure ...
unsigned long endTime = micros();
DEBUG_PRINT("Execution time: ");
DEBUG_PRINT(endTime - startTime);
DEBUG_PRINTLN(" Œºs");
```

**Optimization Strategies:**
1. **FFT Optimization**
   - Use fixed-point arithmetic
   - Reduce FFT size if possible
   - Optimize window function

2. **Task Scheduling**
   - Adjust FreeRTOS priorities
   - Reduce task stack sizes
   - Implement task yielding

3. **Memory Access**
   - Use PSRAM for large buffers
   - Align data structures
   - Minimize heap allocations

## Advanced Debugging Tools

### JTAG Debugging Setup
```bash
# Install OpenOCD
sudo apt install openocd

# Configure JTAG interface
# Edit openocd.cfg for your JTAG adapter

# Start debugging session
openocd -f openocd.cfg

# Connect GDB
xtensa-esp32-elf-gdb .pio/build/esp32-s3-debug/firmware.elf
```

### Memory Analysis
```cpp
// Custom heap analysis function
void analyzeHeap() {
    DEBUG_PRINTLN("=== Heap Analysis ===");
    DEBUG_PRINT("Total heap: ");
    DEBUG_PRINTLN(ESP.getHeapSize());
    DEBUG_PRINT("Free heap: ");
    DEBUG_PRINTLN(ESP.getFreeHeap());
    DEBUG_PRINT("Max alloc: ");
    DEBUG_PRINTLN(ESP.getMaxAllocHeap());
    DEBUG_PRINT("Fragmentation: ");
    DEBUG_PRINT(ESP.getHeapFragmentation());
    DEBUG_PRINTLN("%");
}
```

### Network Packet Analysis
```bash
# Capture network traffic
sudo tcpdump -i wlan0 host esp32-bpm.local -w capture.pcap

# Analyze with Wireshark
wireshark capture.pcap
```

## Automated Diagnostic Script

```python
#!/usr/bin/env python3
# scripts/diagnose_esp32.py

import requests
import time
import json

def diagnose_esp32(ip_address="esp32-bpm.local"):
    """Automated ESP32 diagnostic script"""

    print(f"üîç Diagnosing ESP32 at {ip_address}")

    # Test basic connectivity
    try:
        response = requests.get(f"http://{ip_address}/api/v1/system/health", timeout=5)
        if response.status_code == 200:
            print("‚úÖ Network connectivity: OK")
        else:
            print("‚ùå Network connectivity: FAILED")
            return False
    except:
        print("‚ùå Network connectivity: FAILED")
        return False

    # Test BPM detection
    try:
        response = requests.get(f"http://{ip_address}/api/v1/bpm/current", timeout=5)
        bpm_data = response.json()
        bpm = bpm_data.get('bpm', 0)
        confidence = bpm_data.get('confidence', 0)

        if confidence > 0.5 and 60 <= bpm <= 200:
            print(f"‚úÖ BPM detection: OK (BPM: {bpm}, Confidence: {confidence})")
        else:
            print(f"‚ö†Ô∏è BPM detection: POOR (BPM: {bpm}, Confidence: {confidence})")
    except:
        print("‚ùå BPM detection: FAILED")

    # Test system status
    try:
        response = requests.get(f"http://{ip_address}/api/v1/system/status", timeout=5)
        status_data = response.json()
        heap_usage = status_data.get('free_heap_bytes', 0)
        cpu_usage = status_data.get('cpu_usage_percent', 0)

        if heap_usage > 100000:  # 100KB free
            print(f"‚úÖ Memory usage: OK ({heap_usage} bytes free)")
        else:
            print(f"‚ö†Ô∏è Memory usage: LOW ({heap_usage} bytes free)")

        if cpu_usage < 70:
            print(f"‚úÖ CPU usage: OK ({cpu_usage}%)")
        else:
            print(f"‚ö†Ô∏è CPU usage: HIGH ({cpu_usage}%)")
    except:
        print("‚ùå System status: FAILED")

    print("üéØ Diagnosis complete")
    return True

if __name__ == "__main__":
    diagnose_esp32()
```

## Firmware Recovery Procedures

### Soft Reset (Recommended)
```cpp
// Add to main.cpp loop()
if (digitalRead(RESET_BUTTON_PIN) == LOW) {
    ESP.restart();  // Clean restart
}
```

### Hard Reset (Factory Reset)
```cpp
// Erase all settings and restart
void factoryReset() {
    // Clear WiFi credentials
    // Reset calibration data
    // Erase stored configuration
    ESP.eraseConfig();
    ESP.restart();
}
```

### Firmware Reprogramming
```bash
# Force firmware upload
pio run -e esp32-s3-debug -t upload --upload-port /dev/ttyACM0

# With verbose output
pio run -e esp32-s3-debug -t upload -v

# Erase flash first (nuclear option)
pio run -e esp32-s3-debug -t erase
```

## Support Resources

### Documentation
- [ESP32 Technical Reference Manual](https://www.espressif.com/sites/default/files/documentation/esp32_technical_reference_manual_en.pdf)
- [ArduinoFFT Library Documentation](https://github.com/kosme/arduinoFFT)
- [FlatBuffers Documentation](https://google.github.io/flatbuffers/)

### Community Resources
- [ESP32 Forum](https://esp32.com/)
- [PlatformIO Community](https://community.platformio.org/)
- [Arduino Audio Projects](https://forum.arduino.cc/c/arduino-audio/71)

### Professional Support
- Espressif Technical Support
- PlatformIO Enterprise Support
- Audio DSP Consulting Services

*This troubleshooting guide was automatically generated using MCP-Prompts comprehensive debugging assistance and ESP32 expertise.*
